#!/usr/bin/env fish

set -l script_dir (status dirname)
set -l basename (basename "$script_dir")

echo "Updating '$basename'"

set -l url 'https://api.github.com/repos/fooyin/fooyin/releases/latest'
set -l libvgm_url 'https://api.github.com/repos/fooyin/fooyin/contents/3rdparty/libvgm'
set -l regex 'v([\\d.]+)'
set -l sha1_regex '([\\w]{40})'
set -l jsonpath '$.tag_name'

echo 'Executing the `parse-json` script'
set -l latest_version ("$script_dir/../../scripts/parse-json" $url $regex $jsonpath)

if test -z "$latest_version"
  echo "Failed to get the latest version for '$basename'"
  echo 'Exitting...'
  exit 1
end

set -l latest_libvgm_sha1 ("$script_dir/../../scripts/parse-json" $libvgm_url $sha1_regex '$.sha')

set -l current_version (cat "$script_dir/$basename.spec" | rg -or '$1' 'Version:\\s*([\\d.]+)')

set -l current_libvgm_sha1 (cat "$script_dir/$basename.spec" | rg -or '$1' 'libvgm_sha1\\s([\\w]{40})')

echo 'Comparing the current version ($current_version) with the latest version ($latest_version)'
echo "Current version: $current_version"
echo "Latest version: $latest_version"
echo "Current libvgm SHA1 hash: $current_libvgm_sha1"
echo "Latest libvgm SHA1 hash: $latest_libvgm_sha1"
if test "$current_version" != "$latest_version"
  echo 'Versions are different. Updating the spec file(s)...'
  for v in (fd --glob '*.spec' $script_dir)
    sd "(Version\\:\\s*)$current_version" "\${1}$latest_version" $v
    sd "(libvgm_sha1\\s)$current_libvgm_sha1" "\${1}$latest_libvgm_sha1" $v
  end && echo 'Done!'
else
  echo 'Both versions are the same. No update needed.'
end

echo "Finished updating '$basename'"
