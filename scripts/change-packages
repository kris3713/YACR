#!/usr/bin/env fish

set -l script_dir (status dirname)

set -l webhook_rebuild $argv[1]

# echo $webhook_rebuild

for v in (fd 'spec' "$script_dir/../packages" -t file --format '{}')
  # Get subdir name (ie. the directory that contains the spec file(s))
  set -l split_dir (string split '/' $v)
  set -l subdir $split_dir[-2]
  set -l name (basename -s '.spec' $split_dir[-1])

  echo '--------------------------------------------'
  echo 'Clone URL: https://github.com/kris3713/YACR.git'
  echo 'Commitish: master'
  echo "Subdir: packages/$subdir"
  echo "Spec: $name.spec"
  echo "Pkg Name: $name"
  echo "Webhook Rebuild: $webhook_rebuild"
  echo 'COPR Project: YACR'
  echo "COPR User: $(copr-cli whoami)"

  copr-cli edit-package-scm \
    --clone-url 'https://github.com/kris3713/YACR.git' \
    --commit 'master' \
    --subdir "packages/$subdir" \
    --spec "$name.spec" \
    --name $name \
    --webhook-rebuild $webhook_rebuild \
    'YACR'
end
